# How to Test ScopeKit

This guide complements the monorepo README and explains, with the same level of detail, how to validate that ScopeKit applies the multi-tenant scope in the Node service and that the PHP ERP respects that isolation.

## Prerequisites

- Docker Desktop (or Docker Engine plus the Compose plugin) running.
- `.env` file in the repository root with the desired values (`MYSQL_PORT`, `NODE_API_PORT`, `PHP_HTTP_PORT`, `LOGIN_USERNAME`, `LOGIN_PASSWORD`).
- Local images built at least once with `docker compose up --build`.

> All commands are executed from `Technical Challenge ERP SaaS/challenge/saas-challenge`.

## 1. Start the Stack

1. Bring the containers up (rebuild if you changed configuration such as ports):

   ```powershell
   docker compose up --build
   ```

2. Wait to see in the logs:
   - `Credential service listening on port 3000`
   - `Apache/2.4... (Unix) ... configured -- resuming normal operations`

3. Confirm the services are running:

   ```powershell
   docker compose ps
   ```

   You should see `erp-node-api` and `erp-php` with the published ports (`3000->3000`, `8080->80`, unless you changed `.env`).

## 2. Validate Service Health

1. Node API:

   ```powershell
   Invoke-RestMethod http://localhost:3000/health
   ```

   Expected response:

   ```powershell
   status
   ------
   ok
   ```

2. PHP ERP (sign in with the credentials configured in `.env`):

   ```powershell
   Invoke-RestMethod -Uri http://localhost:8080/login -Method POST `
     -Headers @{ "Content-Type" = "application/json" } `
     -Body '{"username":"isa_6464","password":"6464","clientEmail":"client1@example.com"}'
   ```

   Adjust `username` and `password` if you changed the values. You should receive `Authentication successful` with `tenant` and `storage`.

## 3. Test ScopeKit Persistence in Node

1. Export the variable to require an admin/super-admin role (only affects the Node container):

   ```powershell
   $env:CREDENTIALS_REQUIRE_ADMIN = "true"
   docker compose up --build node-api
   ```

   > If you prefer editing `docker-compose.yml`, add the variable under `services.node-api.environment` and bring the full stack up again.

2. Call the endpoint without headers:

   ```powershell
   Invoke-RestMethod -Uri http://localhost:3000/client/client1@example.com -Method POST
   ```

   Expected result: `403 Forbidden: admin only`.

3. Repeat the request with super admin headers:

   ```powershell
   $headers = @{
     "X-Entity-Id" = "1"
     "X-Roles"     = "super-admin,authenticated"
     "X-Admin"     = "true"
     "Content-Type" = "application/json"
   }

   Invoke-RestMethod -Uri http://localhost:3000/client/client1@example.com `
     -Method POST -Headers $headers -Body '{"requestedAt":"test"}'
   ```

   You should receive the payload with `tenant`, `db`, and `storage`. This shows that ScopeKit reads the headers and allows the bypass when the entity has permissions.

## 4. Verify Tenant Isolation in PHP

1. List the colors for `client1`:

   ```powershell
   Invoke-RestMethod "http://localhost:8080/colors?clientEmail=client1@example.com"
   ```

2. List the colors for `client2`:

   ```powershell
   Invoke-RestMethod "http://localhost:8080/colors?clientEmail=client2@example.com"
   ```

   Each response should contain only the records from its corresponding database.

3. Insert a new color for `client1`:

   ```powershell
   Invoke-RestMethod -Uri http://localhost:8080/colors -Method POST `
     -Headers @{ "Content-Type" = "application/json" } `
     -Body '{"clientEmail":"client1@example.com","name":"Azure","hexadecimal":"#007FFF"}'
   ```

   Call the list from step 1 again: you will see the new color only under `client1`.

4. (Optional) Insert a record for `client2` and make sure it does not show up under `client1`.

## 5. Trace the Principal in the Logs (Optional)

During development you can log the principal generated by ScopeKit to debug headers:

```js
// node-api/src/server.js
app.use(principalMiddleware({...}));

if (process.env.NODE_ENV !== 'production') {
  app.use((req, _res, next) => {
    console.log('principal', req.principal);
    next();
  });
}
```

Restart the Node container and watch the logs while sending requests. Once you validate the flow, remove or comment out the temporary middleware.

## 6. Clean Up the Environment

When you finish testing:

```powershell
docker compose down -v
```

This removes containers and volumes so the environment is clean.

---

With these steps you verify:

- ScopeKit requires the correct headers and roles before serving credentials.
- Downstream services respect the scope per entity/tenant.
- The supporting tools (logs and manual tests) allow you to audit any ScopeKit integration.
